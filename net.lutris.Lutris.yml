id: net.lutris.Lutris
sdk: org.gnome.Sdk
runtime: org.gnome.Platform
runtime-version: "3.38"
base: org.flathub.WineBaseApp
base-version: "20.08"
command: lutris
rename-icon: lutris
copy-icon: true
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=all
  - --share=network
  - --allow=multiarch
  - --allow=devel
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.gnome.Mutter.DisplayConfig
  - --filesystem=~/Games:create
  - --filesystem=xdg-desktop
  - --filesystem=xdg-documents
  - --filesystem=xdg-pictures
  - --filesystem=xdg-music
  - --filesystem=xdg-videos
  - --filesystem=xdg-download
  - --persist=.wine
  - --filesystem=xdg-data/Steam:ro
  - --filesystem=~/.var/app/com.valvesoftware.Steam:ro
  - --env=PATH=/app/bin:/app/runners/bin:/usr/bin
inherit-extensions:
  - org.freedesktop.Platform.GL32
  - org.freedesktop.Platform.VAAPI.Intel.i386
  - org.freedesktop.Platform.ffmpeg-full
  - org.freedesktop.Platform.ffmpeg_full.i386
add-extensions:
  org.gnome.Platform.Compat.i386:
    directory: lib/i386-linux-gnu
    version: "3.38"

  org.gnome.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    version: "3.38"
    no-autodownload: true

  org.freedesktop.Platform.GL32:
    directory: lib/i386-linux-gnu/GL
    version: "1.4"
    versions: "20.08;1.4"
    subdirectories: true
    no-autodownload: true
    autodelete: false
    add-ld-path: lib
    merge-dirs: vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d
    download-if: active-gl-driver
    enable-if: active-gl-driver

  net.lutris.Lutris.Runner:
    directory: runners
    subdirectories: true
    merge-dirs: bin
    no-autodownload: true
    autodelete: true

  com.valvesoftware.Steam.CompatibilityTool:
    version: beta
    versions: stable;
    subdirectories: true
    directory: share/steam/compatibilitytools.d
    no-autodownload: true

  com.valvesoftware.Steam.Utility:
    subdirectories: true
    directory: utils
    version: beta
    versions: stable;beta;test
    add-ld-path: lib
    merge-dirs: bin;share/vulkan/explicit_layer.d;share/vulkan/implicit_layer.d;
    no-autodownload: true

sdk-extensions:
  - org.gnome.Sdk.Compat.i386
  - org.freedesktop.Sdk.Extension.toolchain-i386

x-compat-i386-opts: &compat_i386_opts
  prepend-pkg-config-path: /app/lib32/pkgconfig:/usr/lib/i386-linux-gnu/pkgconfig
  ldflags: -L/app/lib32
  append-path: /usr/lib/sdk/toolchain-i386/bin
  env:
    CC: i686-unknown-linux-gnu-gcc
    CXX: i686-unknown-linux-gnu-g++
  libdir: /app/lib32

cleanup:
  - "*.a"
  - "*.la"
  - /share/man
  - /share/help
cleanup-commands:
  - python3 -m compileall /app/lib
modules:

  - name: lutris
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    post-install:
      - desktop-file-edit --set-key=X-Flatpak-RenamedFrom --set-value="lutris.desktop;" /app/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: archive
        url: "https://github.com/lutris/lutris/archive/v0.5.8.2.tar.gz"
        sha256: 6c2ac4810764fbae9fc6b4e68fb76c47371046ac4e5bdf9e7fcd9777d1b9d8c7
    modules:
      - name: gnome-desktop
        buildsystem: meson
        sources:
          - type: archive
            url: "https://download.gnome.org/sources/gnome-desktop/3.38/gnome-desktop-3.38.1.tar.xz"
            sha256: 17903513fed60814e967512dd892751cb6a1d2716136232884bc65bd53cc3be0

      - name: python-evdev
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=/app --root=/
        sources:
          - type: archive
            url: "https://github.com/gvalkov/python-evdev/archive/v1.3.0.tar.gz"
            sha256: 816367233ee23d86cef9b465bfdbaa778ab01e9a23d7604791acf7ff9434efe2

      - name: python-distro
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=/app --root=/
        sources:
          - type: archive
            url: "https://github.com/nir0s/distro/archive/v1.5.0.tar.gz"
            sha256: 041f191644efd0c50b53af819c201a3ec27cca61781800aa31a7235699b4918f

      - name: python-dbus
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=/app --root=/
        sources:
          - type: archive
            url: "https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.2.16.tar.gz"
            sha256: 11238f1d86c995d8aed2e22f04a1e3779f0d70e587caffeab4857f3c662ed5a4

      - name: PyYAML
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=/app --root=/
        sources:
          - type: archive
            url: "https://github.com/yaml/pyyaml/archive/5.3.1.tar.gz"
            sha256: 56b26f182e2418fab806322706f8a715e1fdcd2d84cb4daa65d236064417a4fe

      - name: python-requests
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=/app --root=/
        sources:
          - type: archive
            url: "https://github.com/requests/requests/archive/v2.24.0.tar.gz"
            sha256: 904e9a2bd22e98e444f5b23f80fa3fb8dda5d1e81d0f87d9ee56af2e15f73862
        modules:

          - name: python-urllib3
            buildsystem: simple
            build-commands:
              - python3 setup.py install --prefix=/app --root=/
            sources:
              - type: archive
                url: "https://github.com/urllib3/urllib3/archive/1.25.11.tar.gz"
                sha256: 50aa25b421b603722dd3db73a5ff6e1871e4153d1dbdf8fd31b02682907da4b2

          - name: python-chardet
            buildsystem: simple
            build-commands:
              - python3 setup.py install --prefix=/app --root=/
            sources:
              - type: archive
                url: "https://github.com/chardet/chardet/archive/3.0.4.tar.gz"
                sha256: d5620025cfca430f6c2e28ddbc87c3c66a5c82fa65570ae975c92911c2190189

          - name: python-certifi
            buildsystem: simple
            build-commands:
              - python3 setup.py install --prefix=/app --root=/
            sources:
              - type: archive
                url: "https://github.com/certifi/python-certifi/archive/2020.06.20.tar.gz"
                sha256: 323a62f5ddfa1a4f093246b52f451aacb725b6cc8eefe647ad6f8bcbed3c9131

          - name: python-idna
            buildsystem: simple
            build-commands:
              - python3 setup.py install --prefix=/app --root=/
            sources:
              - type: archive
                url: "https://github.com/kjd/idna/archive/v2.10.tar.gz"
                sha256: c4b68473823affb02120ad1b199f1d8dd94f1ffa1595ff6fbeb70b1d5fa535bb

          - name: python-magic
            buildsystem: simple
            build-commands:
              - python3 setup.py install --prefix=/app --root=/
            sources:
              - type: archive
                url: "https://github.com/ahupp/python-magic/archive/0.4.18.tar.gz"
                sha256: b787e8056c115f37e2af11e0b98dc67d5fc182ed5ed827a62f95e3a7f0ed4be4

          - name: python-lxml
            buildsystem: simple
            build-commands:
              - python3 setup.py install --prefix=/app --root=/
            sources:
              - type: archive
                url: "https://files.pythonhosted.org/packages/db/f7/43fecb94d66959c1e23aa53d6161231dca0e93ec500224cf31b3c4073e37/lxml-4.6.2.tar.gz"
                sha256: cd11c7e8d21af997ee8079037fff88f16fda188a9776eb4b81c7e4c9c0a7d7fc

      - name: Pillow
        buildsystem: simple
        build-commands:
          - python3 setup.py build -j $FLATPAK_BUILDER_N_JOBS
          - python3 setup.py install --prefix=/app --root=/
        sources:
          - type: archive
            url: "https://github.com/python-pillow/Pillow/archive/8.0.1.tar.gz"
            sha256: 004c1fce0d3427fdba9cb67b445aa7f9926ec5c1ba58760942e8c0374239fec0

  # Multilib dependencies for native games and runners

  - name: libbsd
    sources: &libbsd_sources
      - type: archive
        url: "https://libbsd.freedesktop.org/releases/libbsd-0.10.0.tar.xz"
        sha256: 34b8adc726883d0e85b3118fa13605e179a62b31ba51f676136ecb2d0bc1a887

  - name: libbsd-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
    sources: *libbsd_sources


  - name: sndio11
    config-opts: &sndio_config_opts
      - --with-libbsd
    cleanup: &sndio_cleanup
      - /bin
    sources: &sndio11_sources
      - type: archive
        url: "http://archive.ubuntu.com/ubuntu/pool/universe/s/sndio/sndio_1.1.0.orig.tar.gz"
        sha256: fcd7f845ff70f38c2898d737450b8aa3e1bb0afb9d147e8429ef22c0b2c2db57
      - type: shell
        commands:
          - |
            for i in libsndio aucat midicat; do
              sed 's/cp /cp -f /g' -i $i/Makefile.in
            done

  - name: sndio11-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
    config-opts: *sndio_config_opts
    cleanup: *sndio_cleanup
    sources: *sndio11_sources


  - name: gamemode
    buildsystem: meson
    config-opts: &gamemode_config_opts
      - -Dwith-systemd=false
      - -Dwith-daemon=false
      - -Dwith-examples=false
      - -Dwith-util=false
      - -Dwith-sd-bus-provider=no-daemon
    sources: &gamemode_sources
      - type: archive
        url: "https://github.com/FeralInteractive/gamemode/releases/download/1.6/gamemode-1.6.tar.xz"
        sha256: ede17eb042c1c87f7b35bfe96a00560afaea086f685d25bb3964d794b0af9c80

  - name: gamemode-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
    buildsystem: meson
    config-opts: *gamemode_config_opts
    sources: *gamemode_sources

  - name: libcaca
    config-opts: &libcaca_config_opts
      - --disable-doc
      - --disable-python
      - --disable-ruby
      - --disable-static
    sources: &libcaca_sources
      - type: archive
        url: http://caca.zoy.org/files/libcaca/libcaca-0.99.beta19.tar.gz
        sha256: 128b467c4ed03264c187405172a4e83049342cc8cc2f655f53a2d0ee9d3772f4

  - name: libcaca-32bit
    build-options:
      arch:
        x86_64: *compat_i386_opts
    config-opts: *libcaca_config_opts
    sources: *libcaca_sources

  # Standalone utilities

  - name: hwdata
    config-opts:
      - --datarootdir=/app/share
    sources:
      - type: archive
        url: "https://github.com/vcrhonek/hwdata/archive/v0.340.tar.gz"
        sha256: e3a0ef18af6795a362345a2c2c7177be351cb27b4cc0ed9278b7409759258802

  - name: pciutils
    no-autogen: true
    make-args:
      - SHAREDIR=/app/share/hwdata
      - OPT=-O2 -g
    make-install-args:
      - PREFIX=/app
      - SBINDIR=/app/bin
      - SHAREDIR=/app/share/hwdata
      - MANDIR=/app/share/man
    sources:
      - type: archive
        url: "https://mirrors.edge.kernel.org/pub/software/utils/pciutils/pciutils-3.7.0.tar.gz"
        sha256: 2432e7a2e12000502d36cf769ab6e5a0cf4931e5050ccaf8b02984b2d3cb0948

  - name: usbutils
    config-opts:
      - --datadir=/app/share/hwdata
      - --sbindir=/app/bin
    sources:
      - type: archive
        url: "https://mirrors.edge.kernel.org/pub/linux/utils/usb/usbutils/usbutils-013.tar.xz"
        sha256: 9e23494fcc78b7a80ee29a07dd179c95ae2f71509c35728dbbabc2d1cca41338
    modules:
      - shared-modules/libusb/libusb.json

  - name: xrandr
    sources:
      - type: archive
        url: "https://xorg.freedesktop.org/archive/individual/app/xrandr-1.5.1.tar.gz"
        sha256: 7b99edb7970a1365eaf5bcaf552144e4dfc3ccf510c4abc08569849929fb366e

  - name: mesa-demos
    config-opts:
      - --without-glut
      - --bindir=/app/lib/mesa-demos
    make-args:
      - -C
      - src/xdemos
      - glxinfo
    no-make-install: true
    build-commands:
      - install -D src/xdemos/glxinfo -t /app/bin/
    sources:
      - type: archive
        url: "https://mesa.freedesktop.org/archive/demos/mesa-demos-8.4.0.tar.bz2"
        sha256: 01e99c94a0184e63e796728af89bfac559795fb2a0d6f506fa900455ca5fff7d
    cleanup:
      - /lib/mesa-demos

  - name: psmisc
    sources:
      - type: archive
        url: "https://downloads.sourceforge.net/psmisc/psmisc-23.3.tar.xz"
        sha256: 41750e1a5abf7ed2647b094f58127c73dbce6876f77ba4e0a7e0995ae5c7279a

  # Required by some 8/16-bit emulators

  - name: fluidsynth
    buildsystem: cmake-ninja
    config-opts:
      - -Denable-pulseaudio:BOOL=ON
      - -Denable-alsa:BOOL=OFF
      - -Denable-oss:BOOL=OFF
      - -DLIB_SUFFIX=
    sources:
      - type: archive
        url: "https://github.com/FluidSynth/fluidsynth/archive/v2.1.5.tar.gz"
        sha256: b539b7c65a650b56f01cd60a4e83c6125c217c5a63c0c214ef6274894a677d00

  - name: fluid-soundfont
    buildsystem: simple
    build-commands:
      - install -Dm644 FluidR3_GS.sf2 -t /app/share/sounds/sf2/
    sources:
      - type: archive
        url: "http://deb.debian.org/debian/pool/main/f/fluid-soundfont/fluid-soundfont_3.1.orig.tar.gz"
        md5: 189bbdf70221018cbda536984b105dfa

  # Required by electron and some proprietary game launchers

  - shared-modules/gtk2/gtk2.json

  - shared-modules/dbus-glib/dbus-glib-0.110.json

  - name: gconf
    config-opts:
      - --disable-static
      - --disable-gtk-doc
      - --disable-orbit
      - --disable-introspection
    cleanup:
      - /bin
      - /libexec
      - /share
      - /etc
    sources:
      - type: archive
        url: "https://download.gnome.org/sources/GConf/3.2/GConf-3.2.6.tar.xz"
        sha256: 1912b91803ab09a5eed34d364bf09fe3a2a9c96751fde03a4e0cfa51a04d784c

  # Environment setup

  - name: lutris-app-environment
    buildsystem: simple
    build-commands:
      - mkdir -p /app/runners
      - mkdir -p /app/share/steam/compatibilitytools.d
      - mkdir -p /app/utils /app/share/vulkan
      - ln -srv /app/{utils/,}share/vulkan/explicit_layer.d
      - ln -srv /app/{utils/,}share/vulkan/implicit_layer.d
